<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Higher Education Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif;
            background-color: #0c111c;
            color: #e2e8f0; /* slate-200 */
            overflow-x: hidden;
        }

        #app-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background-color: #0c111c;
            background-image: linear-gradient(180deg, #0c111c 0%, #000000 100%);
            overflow: hidden;
        }

        #app-bg svg {
            position: absolute;
            width: 100%;
            height: 100%;
            transform-origin: 50% 50%;
            animation: bg-pan 60s linear infinite;
        }
        
        @keyframes bg-pan {
            0% { transform: scale(1.2) translate(0, 0); }
            50% { transform: scale(1.4) translate(10px, 20px); }
            100% { transform: scale(1.2) translate(0, 0); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.6s ease-out forwards;
        }

        .dashboard-panel, .sidebar, .search-form-container, .insights-panel {
            background-color: rgba(12, 17, 28, 0.6); /* Translucent dark slate */
            backdrop-filter: blur(12px) saturate(150%);
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease-in-out;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .dashboard-panel:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            border-color: rgba(251, 191, 36, 0.5); /* amber-400 */
        }
        
        .loader {
            width: 48px; height: 48px; border: 5px solid #334155;
            border-bottom-color: #fbbf24; /* amber-400 */
            border-radius: 50%;
            display: inline-block; box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .tab-button {
            padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600;
            cursor: pointer; transition: all 0.2s; 
            color: #94a3b8; /* slate-400 */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .tab-button.active { 
            background-color: #f59e0b; /* amber-500 */
            color: #1e293b; /* slate-800 */
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.4);
        }
        .tab-button:not(.active):hover {
            background-color: rgba(30, 41, 59, 0.7);
            color: #e2e8f0;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.4s ease-out; }
        
        .star-rating { display: flex; flex-direction: row-reverse; justify-content: flex-end; }
        .star-rating input[type="radio"] { display: none; }
        .star-rating label { font-size: 1.75rem; color: #475569; cursor: pointer; transition: color 0.2s; }
        .star-rating input[type="radio"]:checked ~ label,
        .star-rating label:hover,
        .star-rating label:hover ~ label { color: #f59e0b; }

        .action-button {
            background: linear-gradient(to right, #fbbf24, #f59e0b); /* amber-400 to amber-500 */
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px 0 rgba(251, 191, 36, 0.3);
            color: #1e293b;
        }

        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px 0 rgba(251, 191, 36, 0.5);
        }
        
        /* Style for mobile toggle buttons when active */
        .action-button.active-mobile-btn {
            background: linear-gradient(to right, #f59e0b, #d97706); /* amber-500 to amber-600 */
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.6), inset 0 2px 4px rgba(0,0,0,0.2);
        }

        .sidebar {
            width: 100%; /* Changed for mobile */
            padding: 1.5rem;
            max-height: calc(100vh - 4rem);
            overflow-y: auto;
        }
        @media (min-width: 1024px) { /* lg breakpoint */
            .sidebar {
                width: 280px;
            }
        }
        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            color: #94a3b8;
            font-weight: 500;
            transition: all 0.2s;
        }
        .sidebar-link:hover, .sidebar-link.active {
            background-color: rgba(255, 255, 255, 0.05);
            color: #fbbf24;
        }
        .sidebar-header {
            color: #fbbf24;
            font-weight: 700;
            padding: 0.5rem 1rem;
            margin-top: 1rem;
        }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">
    <div id="app-bg">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000">
            <defs>
                <radialGradient id="grad1" cx="50%" cy="50%" r="50%" fx="50%" fy="50%">
                    <stop offset="0%" style="stop-color:rgba(251,191,36,0.1);stop-opacity:1" />
                    <stop offset="100%" style="stop-color:rgba(251,191,36,0);stop-opacity:0" />
                </radialGradient>
            </defs>
            <circle cx="200" cy="300" r="150" fill="url(#grad1)" />
            <circle cx="800" cy="700" r="200" fill="url(#grad1)" />
            <circle cx="500" cy="500" r="100" fill="url(#grad1)" />
        </svg>
    </div>

    <!-- Mobile-only Toggles -->
    <div class="lg:hidden flex flex-col sm:flex-row gap-4 mb-6 fade-in">
        <button id="toggle-nav-btn" class="w-full flex-1 action-button font-bold py-3 px-6 rounded-md text-lg flex items-center justify-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
            Navigator
        </button>
        <button id="toggle-alerts-btn" class="w-full flex-1 action-button font-bold py-3 px-6 rounded-md text-lg flex items-center justify-center gap-2">
             <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            Global Alerts
        </button>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 max-w-screen-2xl mx-auto">
        
        <!-- Main Content (order-2 on desktop) -->
        <main class="lg:col-span-6 lg:order-2 min-w-0">
            <!-- Header -->
            <header class="mb-8 text-center lg:text-left fade-in" style="animation-delay: 0.1s;">
                 <h1 class="text-4xl sm:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-amber-300 to-amber-500 tracking-tight">Higher Education Hub</h1>
                <p class="text-gray-400 mt-2 text-lg">Your live dashboard for global student insights.</p>
            </header>
            
            <!-- Search Form -->
            <div class="search-form-container mb-8 p-6 fade-in" style="animation-delay: 0.2s;">
                <form id="search-form" class="flex flex-col sm:flex-row gap-4 items-center">
                    <div class="flex-grow w-full">
                        <label for="country-input" class="sr-only">Country Name</label>
                        <input type="text" id="country-input" placeholder="Enter a country to research..." class="w-full bg-slate-700/80 border border-slate-600/80 rounded-md shadow-sm py-3 px-4 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent text-lg">
                    </div>
                    <button type="submit" class="w-full sm:w-auto action-button font-bold py-3 px-8 rounded-md text-lg">
                        Research
                    </button>
                </form>
            </div>
            
            <!-- Results Grid -->
            <div id="results-container" class="grid grid-cols-1 gap-8">
                 <!-- Country cards will be loaded here -->
            </div>
        </main>

        <!-- Sidebar (order-1 on desktop) -->
        <aside id="left-sidebar" class="sidebar lg:col-span-3 lg:order-1 flex-shrink-0 fade-in hidden lg:block">
            <h2 class="text-2xl font-bold text-white mb-6">Navigator</h2>
            <nav id="sidebar-nav" class="space-y-1">
                <!-- Sidebar links will be injected here -->
            </nav>
        </aside>

        <!-- Right Insights Column (order-3 on desktop) -->
        <aside id="right-sidebar" class="lg:col-span-3 lg:order-3 min-w-0 fade-in hidden lg:block" style="animation-delay: 0.3s;">
             <div class="insights-panel p-6 lg:sticky top-8">
                <div class="flex justify-between items-center mb-5">
                    <h2 class="text-2xl font-bold text-amber-400 flex items-center gap-3">
                        <svg class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        Global Alerts
                    </h2>
                    <span id="last-updated-timestamp" class="text-sm text-gray-500 mt-1"></span>
                </div>
                 <div id="vital-news-container" class="space-y-4">
                     <!-- Vital news will be loaded here -->
                 </div>
                  <div class="mt-6">
                     <label for="currency-select" class="text-sm font-medium text-gray-300 mb-2 block">Display Currency</label>
                     <select id="currency-select" class="w-full bg-slate-700/80 border border-slate-600/80 rounded-md shadow-sm py-3 px-4 text-white focus:outline-none focus:ring-2 focus:ring-amber-500">
                         <option value="INR">INR (₹)</option>
                         <option value="USD">USD ($)</option>
                         <option value="EUR">EUR (€)</option>
                         <option value="GBP">GBP (£)</option>
                         <option value="CAD">CAD (C$)</option>
                         <option value="AUD">AUD (A$)</option>
                         <option value="JPY">JPY (¥)</option>
                         <option value="NZD">NZD (NZ$)</option>
                         <option value="SGD">SGD (S$)</option>
                         <option value="CHF">CHF (Fr)</option>
                         <option value="CNY">CNY (¥)</option>
                         <option value="AED">AED (د.إ)</option>
                         <option value="KRW">KRW (₩)</option>
                         <option value="SEK">SEK (kr)</option>
                         <option value="HKD">HKD (HK$)</option>
                     </select>
                </div>
             </div>
        </aside>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // --- CONFIGURATION ---
            const vitalKeywords = ['visa', 'policy', 'new rule', 'tuition', 'alert', 'important', 'update', 'deadline', 'change', 'warning', 'fee hike', 'immigration'];
            const BASELINE_COST_NYC_USD = 1550;
            const allCountries = [
                'Afghanistan', 'Albania', 'Algeria', 'Argentina', 'Armenia', 'Australia', 'Austria', 'Bahamas', 'Bahrain', 'Bangladesh', 'Belarus', 'Belgium', 'Belize', 'Bolivia', 'Bosnia And Herzegovina', 'Botswana', 'Brazil', 'Brunei', 'Bulgaria', 'Cambodia', 'Cameroon', 'Canada', 'Cayman Islands', 'Chile', 'China', 'Colombia', 'Costa Rica', 'Croatia', 'Cuba', 'Cyprus', 'Czech Republic', 'Democratic Republic of the Congo', 'Denmark', 'Dominican Republic', 'Ecuador', 'Egypt', 'El Salvador', 'Estonia', 'Ethiopia', 'Fiji', 'Finland', 'France', 'Georgia', 'Germany', 'Ghana', 'Greece', 'Guatemala', 'Guernsey', 'Guyana', 'Hong Kong (China)', 'Honduras', 'Hungary', 'Iceland', 'India', 'Indonesia', 'Iran', 'Iraq', 'Ireland', 'Israel', 'Isle Of Man', 'Italy', 'Ivory Coast', 'Jamaica', 'Japan', 'Jordan', 'Kazakhstan', 'Kenya', 'Kosovo (Disputed Territory)', 'Kuwait', 'Kyrgyzstan', 'Latvia', 'Lebanon', 'Libya', 'Lithuania', 'Luxembourg', 'Macao (China)', 'Madagascar', 'Malaysia', 'Maldives', 'Malta', 'Mauritius', 'Mexico', 'Moldova', 'Mongolia', 'Montenegro', 'Morocco', 'Mozambique', 'Namibia', 'Nepal', 'Netherlands', 'New Zealand', 'Nicaragua', 'Nigeria', 'North Macedonia', 'Norway', 'Oman', 'Pakistan', 'Palestine', 'Panama', 'Papua New Guinea', 'Paraguay', 'Peru', 'Philippines', 'Poland', 'Portugal', 'Puerto Rico', 'Qatar', 'Romania', 'Russia', 'Rwanda', 'Saudi Arabia', 'Senegal', 'Serbia', 'Singapore', 'Slovakia', 'Slovenia', 'South Africa', 'South Korea', 'Spain', 'Sri Lanka', 'Sweden', 'Switzerland', 'Syria', 'Taiwan', 'Tajikistan', 'Tanzania', 'Thailand', 'Trinidad And Tobago', 'Tunisia', 'Turkey', 'Uganda', 'Ukraine', 'United Arab Emirates', 'United Kingdom', 'United States', 'Uruguay', 'Uzbekistan', 'Venezuela', 'Vietnam', 'Yemen', 'Zambia', 'Zimbabwe'
            ];
            const placeholderFlagSvg = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%23475569'%3E%3Cpath fill-rule='evenodd' d='M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 8.027a6.012 6.012 0 011.912-2.706C6.512 5.73 6.512 5.73 6.512 5.73s0 0 0 0a7.006 7.006 0 015.022 4.122C11.533 11.24 10.97 12 10 12c-.97 0-1.533-.76-1.955-1.858A6.007 6.007 0 014.332 8.027zM11.955 10.142C12.42 9.043 13.045 8 14 8c.955 0 1.579.715 1.955 1.858A6.007 6.007 0 0115.668 8.027a7.006 7.006 0 01-5.022-4.122C10.647 3.76 11.202 3 12 3c.798 0 1.353.76 1.775 1.858A6.006 6.006 0 0117.668 7.294a7.008 7.008 0 01-1.912 2.706s0 0 0 0c0 0 0 0 0 0a6.012 6.012 0 01-1.912 2.706C13.488 14.27 13.488 14.27 13.488 14.27s0 0 0 0a7.006 7.006 0 01-5.022-4.122C8.467 8.76 9.03 8 10 8c.97 0 1.533.76 1.955 2.142z' clip-rule='evenodd'/%3E%3C/svg%3E`;

            // --- JSONBIN.IO CONFIGURATION ---
            const JSONBIN_API_KEY = '$2a$10$ORssM/JFzmLqsCpbUYKz..AzQnSrptMlmtwJBEDUEc4fdkd9xa2Ha';
            const JSONBIN_BIN_ID = '68d671d1ae596e708ffc8400';

            // --- DOM Elements ---
            const searchForm = document.getElementById('search-form');
            const countryInput = document.getElementById('country-input');
            const resultsContainer = document.getElementById('results-container');
            const vitalNewsContainer = document.getElementById('vital-news-container');
            const currencySelect = document.getElementById('currency-select');
            const sidebarNav = document.getElementById('sidebar-nav');
            
            let allCostData = [];
            let selectedCurrency = 'INR';

            // --- CURATED INSIGHTS DATABASE ---
            const countryInsights = {
                'canada': { status: 'Cautious', summary: 'High quality of life and clear immigration pathways, but facing a severe housing crisis and an increasingly competitive job market. Recent government caps on international student permits have created uncertainty.', visaType: 'Study Permit', psw: 'Up to 3 years (PGWP)', officialLink: 'https://www.canada.ca/en/immigration-refugees-citizenship/services/study-canada.html' },
                'germany': { status: 'Positive', summary: 'Excellent value with low/no tuition fees at public universities. Strong economy, especially for engineering and IT. Learning German is crucial for job market success and social integration.', visaType: 'German Student Visa', psw: '18-month Job Seeker Visa', officialLink: 'https://www.germany-visa.org/student-visa/' },
                'united kingdom': { status: 'Mixed', summary: 'Home to world-class universities, but the high cost of living and a tightening job market are significant challenges. Recent changes to visa rules for dependents are a key factor.', visaType: 'Student Visa', psw: '2 years (Graduate Route)', officialLink: 'https://www.gov.uk/student-visa' },
                'australia': { status: 'Mixed', summary: 'Offers a great lifestyle and quality education, with strong demand in healthcare and trades. However, recent visa crackdowns and high living expenses are major concerns for new students.', visaType: 'Student visa (subclass 500)', psw: '2-4 years (TGV)', officialLink: 'https://immi.homeaffairs.gov.au/visas/getting-a-visa/visa-listing/student-500' },
                'united states': { status: 'Mixed', summary: 'Unmatched in university prestige and research opportunities. However, students face very high tuition costs, a complex and competitive job market (H1B lottery), and significant cultural/political divides.', visaType: 'F-1 Visa', psw: '12-36 months (OPT)', officialLink: 'https://travel.state.gov/content/travel/en/us-visas/study.html' },
                'ireland': { status: 'Positive', summary: 'A strong, English-speaking hub for tech and pharmaceutical giants in Europe. Welcoming culture, but a severe housing shortage, particularly in Dublin, is the primary challenge.', visaType: 'Study Visa (Stamp 2)', psw: 'Up to 2 years', officialLink: 'https://www.irishimmigration.ie/coming-to-study-in-ireland/' },
                'netherlands': { status: 'Positive', summary: 'High-quality education with many English-taught programs. A very open and international society. The job market is good, but like Ireland, it faces a significant housing crunch.', visaType: 'MVV / VVR (Student)', psw: '1 year (Orientation Year)', officialLink: 'https://ind.nl/en/study' },
                'new zealand': { status: 'Cautious', summary: 'Renowned for its natural beauty and friendly culture. However, it has a smaller job market and recent immigration tightening has made post-study work prospects more challenging.', visaType: 'Fee Paying Student Visa', psw: '1-3 years', officialLink: 'https://www.immigration.govt.nz/new-zealand-visas/visas/visa/fee-paying-student-visa' }
            };

            // --- DATA FETCHING & HELPERS ---
            const countryNameToCodeMap = {'Afghanistan':'af','Albania':'al','Algeria':'dz','Argentina':'ar','Armenia':'am','Australia':'au','Austria':'at','Bahamas':'bs','Bahrain':'bh','Bangladesh':'bd','Belarus':'by','Belgium':'be','Belize':'bz','Bolivia':'bo','Bosnia And Herzegovina':'ba','Botswana':'bw','Brazil':'br','Brunei':'bn','Bulgaria':'bg','Cambodia':'kh','Cameroon':'cm','Canada':'ca','Cayman Islands':'ky','Chile':'cl','China':'cn','Colombia':'co','Costa Rica':'cr','Croatia':'hr','Cuba':'cu','Cyprus':'cy','Czech Republic':'cz','Democratic Republic of the Congo':'cd','Denmark':'dk','Dominican Republic':'do','Ecuador':'ec','Egypt':'eg','El Salvador':'sv','Estonia':'ee','Ethiopia':'et','Fiji':'fj','Finland':'fi','France':'fr','Georgia':'ge','Germany':'de','Ghana':'gh','Greece':'gr','Guatemala':'gt','Guernsey':'gg','Guyana':'gy','Hong Kong (China)':'hk','Honduras':'hn','Hungary':'hu','Iceland':'is','India':'in','Indonesia':'id','Iran':'ir','Iraq':'iq','Ireland':'ie','Israel':'il','Isle Of Man':'im','Italy':'it','Ivory Coast':'ci','Jamaica':'jm','Japan':'jp','Jordan':'jo','Kazakhstan':'kz','Kenya':'ke','Kosovo (Disputed Territory)':'xk','Kuwait':'kw','Kyrgyzstan':'kg','Latvia':'lv','Lebanon':'lb','Libya':'ly','Lithuania':'lt','Luxembourg':'lu','Macao (China)':'mo','Madagascar':'mg','Malaysia':'my','Maldives':'mv','Malta':'mt','Mauritius':'mu','Mexico':'mx','Moldova':'md','Mongolia':'mn','Montenegro':'me','Morocco':'ma','Mozambique':'mz','Namibia':'na','Nepal':'np','Netherlands':'nl','New Zealand':'nz','Nicaragua':'ni','Nigeria':'ng','North Macedonia':'mk','Norway':'no','Oman':'om','Pakistan':'pk','Palestine':'ps','Panama':'pa','Papua New Guinea':'pg','Paraguay':'py','Peru':'pe','Philippines':'ph','Poland':'pl','Portugal':'pt','Puerto Rico':'pr','Qatar':'qa','Romania':'ro','Russia':'ru','Rwanda':'rw','Saudi Arabia':'sa','Senegal':'sn','Serbia':'rs','Singapore':'sg','Slovakia':'sk','Slovenia':'si','South Africa':'za','South Korea':'kr','Spain':'es','Sri Lanka':'lk','Sweden':'se','Switzerland':'ch','Syria':'sy','Taiwan':'tw','Tajikistan':'tj','Tanzania':'tz','Thailand':'th','Trinidad And Tobago':'tt','Tunisia':'tn','Turkey':'tr','Uganda':'ug','Ukraine':'ua','United Arab Emirates':'ae','United Kingdom':'gb','United States':'us','Uruguay':'uy','Uzbekistan':'uz','Venezuela':'ve','Vietnam':'vn','Yemen':'ye','Zambia':'zm','Zimbabwe':'zw'};
            const getCountryCode = (countryName) => countryNameToCodeMap[countryName.trim()] || null;
            
            const fetchLocalJson = async (filePath) => {
                try {
                    const response = await fetch(filePath);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return await response.json();
                } catch (e) {
                    console.error(`Failed to fetch local JSON file: ${filePath}`, e);
                    return null;
                }
            };
            
            const fetchLiveNews = async (query) => {
                const rssUrl = `https://news.google.com/rss/search?q=${encodeURIComponent(query)}&hl=en-IN&gl=IN&ceid=IN:en`;
                const apiUrl = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rssUrl)}`;
                try {
                    const res = await fetch(apiUrl);
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    const data = await res.json();
                    if (data.status !== 'ok') throw new Error('RSS feed error.');
                    return data.items.map(item => ({
                        title: item.title, link: item.link, source: item.author || "Google News", pubDate: item.pubDate
                    }));
                } catch (error) {
                    console.error("Error fetching RSS feed:", error);
                    return null;
                }
            };
            
            // --- RENDERING & UI LOGIC ---
            const renderSidebar = () => {
                const groupedCountries = allCountries.reduce((acc, country) => {
                    const firstLetter = country.charAt(0).toUpperCase();
                    if (!acc[firstLetter]) acc[firstLetter] = [];
                    acc[firstLetter].push(country);
                    return acc;
                }, {});

                let html = '';
                for (const letter in groupedCountries) {
                    html += `<div class="sidebar-header">${letter}</div>`;
                    html += groupedCountries[letter].map(country => {
                        const countryCode = getCountryCode(country);
                        return `
                            <a href="#" class="sidebar-link" data-country="${country}">
                                <img src="${countryCode ? `https://flagcdn.com/w20/${countryCode}.png` : placeholderFlagSvg}" alt="${country} Flag" class="w-5 h-auto rounded-sm mr-3" loading="lazy">
                                <span>${country}</span>
                            </a>
                        `;
                    }).join('');
                }
                sidebarNav.innerHTML = html;

                sidebarNav.addEventListener('click', e => {
                    const link = e.target.closest('.sidebar-link');
                    if (link) {
                        e.preventDefault();
                        const country = link.dataset.country;
                        renderCountryCard(country);
                        document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
                        link.classList.add('active');
                        
                        // On mobile, hide sidebar after selection
                        if (window.innerWidth < 1024) {
                            const leftSidebar = document.getElementById('left-sidebar');
                            const toggleNavBtn = document.getElementById('toggle-nav-btn');
                            leftSidebar.classList.add('hidden');
                            toggleNavBtn.classList.remove('active-mobile-btn');
                        }
                    }
                });
            };
            
            const renderCountryCard = (countryName) => {
                let panel = document.getElementById(`panel-${countryName.replace(/\s+/g, '-')}`);
                if (panel) {
                    panel.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    panel.style.transition = 'box-shadow 0.3s';
                    panel.style.boxShadow = '0 0 30px rgba(251, 191, 36, 0.5)';
                    setTimeout(() => { panel.style.boxShadow = ''; }, 1000);
                    return;
                }
                
                if (resultsContainer.children.length >= 3) {
                    const oldestCard = resultsContainer.lastElementChild;
                    const country = oldestCard.getAttribute('data-country-name');
                    const sidebarLink = sidebarNav.querySelector(`.sidebar-link[data-country="${country}"]`);
                    if(sidebarLink) sidebarLink.classList.remove('active');
                    oldestCard.style.transition = 'opacity 0.3s, transform 0.3s';
                    oldestCard.style.opacity = '0';
                    oldestCard.style.transform = 'scale(0.95)';
                    setTimeout(() => oldestCard.remove(), 300);
                }
                
                const panelId = `panel-${countryName.replace(/\s+/g, '-')}`;
                const countryCode = getCountryCode(countryName);
                const insight = countryInsights[countryName.toLowerCase()] || { status: 'Info', summary: 'General insights for this country are not available yet. Please conduct detailed research on visa rules, job markets, and local conditions.', visaType: 'N/A', psw: 'N/A', officialLink: '#' };
                const statusColors = { Positive: 'bg-green-500/80 text-green-100', Mixed: 'bg-yellow-500/80 text-yellow-100', Cautious: 'bg-orange-500/80 text-orange-100', Info: 'bg-sky-500/80 text-sky-100' };
                const statusColor = statusColors[insight.status] || 'bg-gray-500';

                panel = document.createElement('div');
                panel.id = panelId;
                panel.className = 'dashboard-panel fade-in p-6'; // Added padding here for consistency
                panel.setAttribute('data-country-name', countryName);
                panel.innerHTML = `
                    <div class="flex justify-between items-start">
                        <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-3">
                            <img src="${countryCode ? `https://flagcdn.com/w40/${countryCode}.png` : placeholderFlagSvg}" alt="${countryName} Flag" class="w-8 h-auto rounded-md shadow-lg">
                            <span>${countryName}</span>
                        </h2>
                        <button class="text-gray-500 hover:text-white transition-colors close-panel-btn text-3xl leading-none">&times;</button>
                    </div>
                    <div class="mb-4 border-b border-slate-700/60 pb-4">
                        <div class="flex items-start gap-4">
                            <div class="flex-shrink-0"><span class="font-bold text-xs py-1 px-3 rounded-full ${statusColor}">${insight.status}</span></div>
                            <div>
                                <h3 class="font-semibold text-base text-gray-200">Student Outlook</h3>
                                <p class="text-sm text-gray-400 mt-1">${insight.summary}</p>
                            </div>
                        </div>
                    </div>
                   <div class="flex flex-wrap gap-2 mb-4 p-1 bg-slate-900/50 rounded-lg">
                       <button class="flex-1 tab-button active" data-target="#news-${panelId}">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M2 5a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V5zm14 0H4v10h12V5zM6 7h8v1H6V7zm0 2h8v1H6V9zm0 2h5v1H6v-1z"></path></svg>
                            News
                        </button>
                       <button class="flex-1 tab-button" data-target="#info-${panelId}">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M8 4a3 3 0 100 6 3 3 0 000-6zM12 6a2 2 0 11-4 0 2 2 0 014 0zM8 12c-3.33 0-5 2.5-5 4v1h10v-1c0-1.5-1.67-4-5-4z"></path></svg>
                            Cost & Visa
                       </button>
                       <button class="flex-1 tab-button" data-target="#scholarships-${panelId}">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path></svg>
                            Scholarships
                       </button>
                       <button class="flex-1 tab-button" data-target="#reviews-${panelId}">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2.5a.75.75 0 01.75.75v.518l.965.348a1.5 1.5 0 01.921 1.954l-.468.995a1.5 1.5 0 01-1.895.945l-1.03-.393a.75.75 0 01-.448 0l-1.03.393a1.5 1.5 0 01-1.895-.945l-.468-.995a1.5 1.5 0 01.92-1.954l.966-.348V3.25A.75.75 0 0110 2.5zM12.5 8a2.5 2.5 0 100-5 2.5 2.5 0 000 5zM7.5 8a2.5 2.5 0 100-5 2.5 2.5 0 000 5zM10 12.5a3.5 3.5 0 100-7 3.5 3.5 0 000 7z"></path><path d="M3.75 14.25a.75.75 0 01.75-.75h11.5a.75.75 0 010 1.5H4.5a.75.75 0 01-.75-.75z"></path></svg>
                            Reviews
                       </button>
                   </div>
                   <div class="flex-grow overflow-y-auto" style="min-height: 350px; max-height: 400px; padding-right: 10px;">
                       <div id="news-${panelId}" class="tab-content active"><div class="loader mx-auto mt-8"></div></div>
                       <div id="info-${panelId}" class="tab-content"><div class="loader mx-auto mt-8"></div></div>
                       <div id="scholarships-${panelId}" class="tab-content"></div>
                       <div id="reviews-${panelId}" class="tab-content"><div class="loader mx-auto mt-8"></div></div>
                   </div>`;

                resultsContainer.prepend(panel);
                
                panel.querySelector('.close-panel-btn').addEventListener('click', () => {
                    const country = panel.getAttribute('data-country-name');
                    const sidebarLink = sidebarNav.querySelector(`.sidebar-link[data-country="${country}"]`);
                    if(sidebarLink) sidebarLink.classList.remove('active');
                    
                    panel.style.transition = 'opacity 0.3s, transform 0.3s';
                    panel.style.opacity = '0';
                    panel.style.transform = 'scale(0.95)';
                    setTimeout(() => panel.remove(), 300);
                });
                
                const tabs = panel.querySelectorAll('.tab-button');
                const contents = panel.querySelectorAll('.tab-content');
                tabs.forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        e.preventDefault(); e.stopPropagation();
                        tabs.forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        contents.forEach(c => c.classList.remove('active'));
                        panel.querySelector(tab.dataset.target).classList.add('active');
                    });
                });

                renderNews(panel.querySelector(`#news-${panelId}`), countryName);
                renderCostAndVisa(panel.querySelector(`#info-${panelId}`), countryName);
                renderScholarships(panel.querySelector(`#scholarships-${panelId}`), countryName);
                renderReviews(panel.querySelector(`#reviews-${panelId}`), countryName);
            };

            const renderNews = async (container, countryName) => {
                if (!container) return;
                const newsItems = await fetchLiveNews(`"${countryName}" international students`);
                if (!newsItems || newsItems.length === 0) {
                    container.innerHTML = `<p class="text-gray-400 p-4 text-center">Could not find any recent news.</p>`; return;
                }
                container.innerHTML = `<div class="space-y-4">${newsItems.slice(0, 10).map(item => `<a href="${item.link}" target="_blank" rel="noopener noreferrer" class="relative block p-4 rounded-lg bg-slate-900/30 hover:bg-slate-900/60 transition-colors border border-slate-700/60 hover:border-amber-500/70"><p class="font-semibold text-white">${item.title}</p><div class="mt-3 pt-3 border-t border-slate-700/60 flex justify-between items-center"><span class="text-xs text-gray-500">Source: ${item.source}</span><span class="text-sm text-amber-400 font-semibold">Read More &rarr;</span></div></a>`).join('')}</div>`;
            };

             const renderVitalNews = async () => {
                const newsItems = await fetchLiveNews(`international student visa policy tuition`);
                if (!vitalNewsContainer) return;
                if (!newsItems || newsItems.length === 0) {
                    vitalNewsContainer.innerHTML = `<p class="text-gray-400 p-4 text-center">No major global alerts found.</p>`; return;
                }
                vitalNewsContainer.innerHTML = newsItems.slice(0, 5).map(item => `<a href="${item.link}" target="_blank" rel="noopener noreferrer" class="block p-4 rounded-lg bg-amber-900/20 hover:bg-amber-900/40 transition-colors border border-amber-700/60 hover:border-amber-500/70"><p class="font-semibold text-amber-100 text-sm">${item.title}</p><div class="mt-2 text-xs text-amber-300">Source: ${item.source}</div></a>`).join('');
            };

            const convertCurrency = async (amountUSD, targetCurrency) => {
                if (targetCurrency === 'USD') return amountUSD;
                try {
                    const response = await fetch(`https://api.frankfurter.app/latest?amount=${amountUSD}&from=USD&to=${targetCurrency}`);
                    if (!response.ok) throw new Error('Network response');
                    const data = await response.json();
                    return data.rates[targetCurrency];
                } catch (error) {
                    console.error("Currency conversion failed:", error);
                    return null;
                }
            };
            
            const renderCostAndVisa = async (container, countryName) => {
                if (!allCostData) {
                    container.innerHTML = `<div class="p-4 rounded-lg bg-slate-900/30 border border-slate-700/60 text-gray-400">Cost data unavailable.</div>`; return;
                }
                const costData = allCostData.find(row => row.Country?.toLowerCase() === countryName.toLowerCase());
                const insightData = countryInsights[countryName.toLowerCase()] || { visaType: 'N/A', psw: 'N/A', officialLink: '#' };
                let costHtml = `<div class="p-4 rounded-lg bg-slate-900/30 border border-slate-700/60 text-gray-400">No cost data for ${countryName}.</div>`;
                if (costData) {
                    const estimatedCostUSD = (costData['Cost of Living Index'] / 100) * BASELINE_COST_NYC_USD;
                    const convertedCost = await convertCurrency(estimatedCostUSD, selectedCurrency);
                    const formattedCost = convertedCost ? new Intl.NumberFormat(undefined, { style: 'currency', currency: selectedCurrency, minimumFractionDigits: 0 }).format(convertedCost) : 'Calculating...';
                    costHtml = `<div class="pb-4 border-b border-slate-700/60"><h4 class="font-semibold text-gray-200 mb-2 text-lg">Estimated Monthly Cost</h4><p class="text-4xl font-bold text-amber-400">${formattedCost} <span class="text-xl font-medium text-gray-400">/ month</span></p><p class="text-xs text-gray-500 mt-1">(Excluding rent, based on Numbeo)</p></div><div class="pt-4"><h4 class="font-semibold text-gray-200 mb-2 text-lg">Cost Indices</h4><ul class="space-y-2 text-gray-300"><li class="flex justify-between"><span>Cost of Living:</span> <span class="font-semibold text-white">${costData['Cost of Living Index'] || 'N/A'}</span></li><li class="flex justify-between"><span>Rent:</span> <span class="font-semibold text-white">${costData['Rent Index'] || 'N/A'}</span></li><li class="flex justify-between"><span>Purchasing Power:</span> <span class="font-semibold text-white">${costData['Local Purchasing Power Index'] || 'N/A'}</span></li></ul><a href="https://www.numbeo.com/cost-of-living/country_result.jsp?country=${encodeURIComponent(countryName)}" target="_blank" rel="noopener noreferrer" class="text-amber-400 hover:underline mt-4 inline-block font-semibold">View Detailed Data &rarr;</a></div>`;
                }
                container.innerHTML = `<div class="space-y-4 text-sm p-4 rounded-lg bg-slate-900/30 border border-slate-700/60">${costHtml}<div class="border-t border-slate-700/60 pt-4 mt-4"><h4 class="font-semibold text-gray-200 mb-2 text-lg">Visa Snapshot</h4><ul class="space-y-2 text-gray-300"><li class="flex justify-between"><span>Primary Visa:</span> <span class="font-semibold text-white">${insightData.visaType}</span></li><li class="flex justify-between"><span>Post-Study Work:</span> <span class="font-semibold text-white">${insightData.psw}</span></li></ul><a href="${insightData.officialLink}" target="_blank" rel="noopener noreferrer" class="text-amber-400 hover:underline mt-4 inline-block font-semibold">Official Immigration Site &rarr;</a></div></div>`;
            };

            const renderScholarships = (container, countryName) => {
                const mastersUrl = `https://www.google.com/search?q=${encodeURIComponent(`site:scholars4dev.com "masters scholarships" "${countryName}"`)}`;
                const bachelorsUrl = `https://www.google.com/search?q=${encodeURIComponent(`site:scholars4dev.com "bachelors scholarships" "${countryName}"`)}`;
                container.innerHTML = `<div class="p-4 rounded-lg bg-slate-900/30 border border-slate-700/60 text-gray-300 space-y-4"><p class="text-center">Find scholarships for <strong>${countryName}</strong> via a targeted Google search.</p><a href="${mastersUrl}" target="_blank" rel="noopener noreferrer" class="block text-center w-full text-slate-800 font-bold py-3 px-4 rounded-md transition-colors action-button">Masters Scholarships &rarr;</a><a href="${bachelorsUrl}" target="_blank" rel="noopener noreferrer" class="block text-center w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-4 rounded-md transition-colors">Bachelors Scholarships &rarr;</a></div>`;
            };

            const fetchReviews = async () => {
                if (JSONBIN_API_KEY.includes('PASTE')) return { reviews: [] };
                try {
                    const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, { headers: { 'X-Master-Key': JSONBIN_API_KEY, 'X-Bin-Meta': false } });
                    if (!response.ok) throw new Error('Failed to fetch reviews');
                    return await response.json() || { reviews: [] };
                } catch (error) { console.error('Error fetching reviews:', error); return { reviews: [] }; }
            };

            const postReview = async (newReview) => {
                if (JSONBIN_API_KEY.includes('PASTE')) return false;
                try {
                    const { reviews = [] } = await fetchReviews();
                    const updatedReviews = [newReview, ...reviews]; 
                    const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'X-Master-Key': JSONBIN_API_KEY },
                        body: JSON.stringify({ reviews: updatedReviews })
                    });
                    return response.ok;
                } catch (error) { console.error('Error posting review:', error); return false; }
            };

            const renderReviews = async (container, countryName) => {
                let formHtml = `<div class="p-4 rounded-lg bg-slate-900/30 border border-slate-700/60"><h4 class="font-bold text-lg text-white mb-3">Share Your Experience</h4><form class="space-y-4" id="review-form-${countryName.replace(/\s+/g, '-')}"><input type="hidden" name="country" value="${countryName}"><div><label class="text-sm font-medium text-gray-300" for="name-${countryName}">Your Name</label><input type="text" id="name-${countryName}" name="name" required class="mt-1 w-full bg-slate-700/80 border border-slate-600/80 rounded-md py-2 px-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="e.g., Anjali S."></div><div><label class="text-sm font-medium text-gray-300">Overall Rating</label><div class="star-rating mt-1"><input type="radio" id="5-stars-${countryName}" name="rating" value="5" required/><label for="5-stars-${countryName}">&#9733;</label><input type="radio" id="4-stars-${countryName}" name="rating" value="4" /><label for="4-stars-${countryName}">&#9733;</label><input type="radio" id="3-stars-${countryName}" name="rating" value="3" /><label for="3-stars-${countryName}">&#9733;</label><input type="radio" id="2-stars-${countryName}" name="rating" value="2" /><label for="2-stars-${countryName}">&#9733;</label><input type="radio" id="1-star-${countryName}" name="rating" value="1" /><label for="1-star-${countryName}">&#9733;</label></div></div><div><label class="text-sm font-medium text-gray-300" for="comment-${countryName}">Your Review</label><textarea id="comment-${countryName}" name="comment" required rows="4" class="mt-1 w-full bg-slate-700/80 border border-slate-600/80 rounded-md py-2 px-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="Share your pros, cons, and tips..."></textarea></div><button type="submit" class="w-full action-button text-slate-800 font-bold py-2 px-4 rounded-md">Submit Review</button><div class="submit-message text-center text-sm pt-2"></div></form></div>`;
                const { reviews = [] } = await fetchReviews();
                const countryReviews = reviews.filter(r => r.country === countryName);
                let reviewsHtml = `<div class="text-center py-6 text-gray-400">Be the first to leave a review!</div>`;
                if (countryReviews.length > 0) {
                    reviewsHtml = countryReviews.map(review => `<div class="p-4 rounded-lg bg-slate-800/50 border border-slate-700/60"><div class="flex justify-between items-start"><div><p class="font-bold text-white">${review.name}</p><p class="text-xs text-gray-400">${new Date(review.timestamp).toLocaleDateString()}</p></div><span class="text-xl text-amber-400" title="${review.rating} out of 5 stars">${'&#9733;'.repeat(review.rating) + '&#9734;'.repeat(5 - review.rating)}</span></div><p class="text-gray-300 mt-3 whitespace-pre-wrap">${review.comment}</p></div>`).join('');
                }
                container.innerHTML = `<div class="space-y-4">${formHtml}<div class="mt-6 space-y-4">${reviewsHtml}</div></div>`;
                container.querySelector('form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const reviewData = { name: formData.get('name'), country: formData.get('country'), rating: parseInt(formData.get('rating'), 10), comment: formData.get('comment'), timestamp: new Date().toISOString() };
                    const submitButton = e.target.querySelector('button[type="submit"]');
                    const messageDiv = e.target.querySelector('.submit-message');
                    submitButton.disabled = true; submitButton.textContent = 'Submitting...';
                    const success = await postReview(reviewData);
                    messageDiv.className = `submit-message text-center text-sm pt-2 ${success ? 'text-green-400' : 'text-red-400'}`;
                    messageDiv.textContent = success ? 'Thank you! Your review has been submitted.' : 'Submission failed. Please try again.';
                    if (success) { e.target.reset(); renderReviews(container, countryName); }
                    submitButton.disabled = false; submitButton.textContent = 'Submit Review';
                });
            };
            
            const updateTimestamp = () => {
                 const timestampEl = document.getElementById('last-updated-timestamp');
                 if (timestampEl) timestampEl.textContent = `Live @ ${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
            };

            const initializeApp = async () => {
                vitalNewsContainer.innerHTML = `<div class="loader mx-auto mt-8"></div>`;
                renderSidebar();
                renderVitalNews();
                
                allCostData = await fetchLocalJson('numbeo_data.json');
                if (!allCostData) {
                    const errorToast = document.createElement('div');
                    errorToast.className = "p-4 text-center bg-red-900/50 rounded-lg text-red-300 mb-4";
                    errorToast.innerHTML = `<p class="font-bold">Database Error</p><p>Could not load cost data.</p>`;
                    document.querySelector('main').prepend(errorToast);
                }
                 
                renderCountryCard('Canada');
                document.querySelector('.sidebar-link[data-country="Canada"]').classList.add('active');
                
                updateTimestamp();
                setInterval(renderVitalNews, 600000); 
            };

            searchForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const country = countryInput.value.trim();
                if (!country) return;
                renderCountryCard(country);
                countryInput.value = '';
                document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
                const newLink = sidebarNav.querySelector(`.sidebar-link[data-country="${country}"]`);
                if(newLink) newLink.classList.add('active');
            });

            currencySelect.addEventListener('change', (e) => {
                selectedCurrency = e.target.value;
                document.querySelectorAll('.dashboard-panel[data-country-name]').forEach(card => {
                    const countryName = card.getAttribute('data-country-name');
                    const costContainer = card.querySelector(`.tab-content[id^="info-"]`);
                    if (costContainer) renderCostAndVisa(costContainer, countryName);
                });
            });

            // --- MOBILE TOGGLE LOGIC ---
            const toggleNavBtn = document.getElementById('toggle-nav-btn');
            const toggleAlertsBtn = document.getElementById('toggle-alerts-btn');
            const leftSidebar = document.getElementById('left-sidebar');
            const rightSidebar = document.getElementById('right-sidebar');

            if (toggleNavBtn && leftSidebar) {
                toggleNavBtn.addEventListener('click', () => {
                    leftSidebar.classList.toggle('hidden');
                    rightSidebar.classList.add('hidden'); // Hide other panel
                    toggleNavBtn.classList.toggle('active-mobile-btn');
                    toggleAlertsBtn.classList.remove('active-mobile-btn');
                });
            }

            if (toggleAlertsBtn && rightSidebar) {
                toggleAlertsBtn.addEventListener('click', () => {
                    rightSidebar.classList.toggle('hidden');
                    leftSidebar.classList.add('hidden'); // Hide other panel
                    toggleAlertsBtn.classList.toggle('active-mobile-btn');
                    toggleNavBtn.classList.remove('active-mobile-btn');
                });
            }

            initializeApp();
        });
    </script>
</body>
</html>
